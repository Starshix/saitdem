{% extends 'portal/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ</h3>
                <a href="{% url 'create_application' %}" class="btn btn-primary">
                    üìù –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                </a>
            </div>
            
            {% if applications %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–ö—É—Ä—Å</th>
                                <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                                <th>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in applications %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ app.course.title }}</td>
                                <td>{{ app.desired_start_date|date:"d.m.Y" }}</td>
                                <td>{{ app.get_payment_method_display }}</td>
                                <td>
                                    <span class="status-{{ app.status }}">
                                        {{ app.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ app.created_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    {% if app.status == 'completed' and not app.feedback %}
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#feedbackModal{{ app.id }}">
                                            –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                                        </button>
                                    {% elif app.feedback %}
                                        <span class="badge bg-success">–û—Ç–∑—ã–≤ –æ—Å—Ç–∞–≤–ª–µ–Ω</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫. <a href="{% url 'create_application' %}">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É!</a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ</h4>
            <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-outline-primary">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
        </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <strong>–§–ò–û:</strong> {{ user.full_name }}
                </li>
                <li class="list-group-item">
                    <strong>–õ–æ–≥–∏–Ω:</strong> {{ user.username }}
                </li>
                <li class="list-group-item">
                    <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ user.phone }}
                </li>
                <li class="list-group-item">
                    <strong>Email:</strong> {{ user.email }}
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ -->
{% for app in applications %}
{% if app.status == 'completed' and not app.feedback %}
<div class="modal fade" id="feedbackModal{{ app.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–û—Ç–∑—ã–≤ –æ –∫—É—Ä—Å–µ: {{ app.course.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="application_id" value="{{ app.id }}">
                <div class="modal-body">
                    {{ feedback_form.feedback }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" name="feedback" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock %}